<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script>


    <!-- CSS to style the file input field as button and adjust the Bootstrap progress bars -->
    <link rel="stylesheet" href="./css/jquery.fileupload.css">
    <link rel="stylesheet" href="./css/jquery.fileupload-ui.css">

    <script src="http://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js"></script>
    <link rel="stylesheet" href="http://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css">
    <!--<link rel="stylesheet" href="/bootstrap/css/bootstrap.css">-->
    <!--<link rel="stylesheet" href="/bootstrap/css/bootstrap-theme.css">-->

    <!--Bootstrap table import -->
    <script src="./js/bootstrap-table.js"></script>
    <link rel="stylesheet" href="./js/bootstrap-table.css">

    <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>


    <link rel="stylesheet" type="text/css" href="http://cdn.leafletjs.com/leaflet-0.7.2/leaflet.css" />
    <script type='text/javascript' src='http://ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js'></script>
    <script type='text/javascript' src='http://cdn.leafletjs.com/leaflet-0.7.2/leaflet.js?2'></script>

</head>
<body>
<script>
    function linkFormatter(value, row) {
        return '<a href="' + value + '">File</a>';
    }

    function generateJSFormatter(value,row, index) {
        var s =  row.serialNumber;
        var f = row.flyDate;

        // console.log(f+ " " + s)
        return  "<a href=\"#\" onclick=\"generateGraphic('"+s+"','"+f+"');\">Draw the fly</a>";

    }

    function generateFlyVisualFormatter(value,row, index) {
        var s =  row.serialNumber;
        var f = row.flyDate;

        // console.log(f+ " " + s)
        return  "<a href=\"#\" onclick=\"generateMap('"+s+"','"+f+"');\">Draw the fly</a>";
    }
</script>

<table data-toggle="table" data-url="/list" id="table">
    <tr>
        <td>Bebop</td>
    </tr>
    <thead>
    <tr>
        <th data-field="serialNumber">Bebop Identifier</th>
        <th data-field="flyDate">Fly date</th>
        <th data-field="kmzFile" data-formatter="linkFormatter">KMZ file</th>
        <th data-field="csvFile" data-formatter="linkFormatter">CSV file</th>
        <th data-field="serialNumber | flyDate" data-formatter="generateJSFormatter">Get Graphic</th>
        <th data-field="flyDuration" data-sortable="true">Fly Duration in minutes</th>
        <th data-field="serialNumber | flyDate" data-formatter="generateFlyVisualFormatter">Display fly</th>
    </tr>
    </thead>
</table>

<id id="myChart"style="width: 900px; height: 500px"></id>

<script type="text/javascript">
    google.charts.load('current', {'packages': ['corechart']});
    function generateGraphic(serialNumber, flyDate)
    {

        google.charts.setOnLoadCallback(drawChart(serialNumber,flyDate));
        function drawChart(serialNumber,flyDate) {

            json = $.ajax({
                dataType: "json",
                url: './chart?serialNumber='+ serialNumber +'&flyDate=' +flyDate.replace('+','%2B'),
                async: false
            }).responseJSON;
            // console.log(json)
            var data = new google.visualization.DataTable();
            data.addColumn('number', 'Time in minutes');
            data.addColumn('number', 'Speed in M/S');
            data.addColumn('number', 'Altitude in M');
            data.addColumn('number', 'Battery level in %');
            data.addRows(json);
            var options = {
                chart: {
                    title: 'fly of the ' + flyDate,
                    curveType: 'function',
                    legend: {position: 'bottom'}
                },
                width: 900,
                height: 500,
                hAxis: {title: 'fly of the ' + flyDate},
                vAxes: {
                    0: {
                        viewWindowMode: 'explicit',
                        viewWindow: {
                            min: 0
                        },
                        gridlines: {color: 'transparent'},
                    },
                    1: {
                        gridlines: {color: 'transparent'},

                    },
                },
                series: {
                    0: {targetAxisIndex: 0},
                    1: {targetAxisIndex: 0},
                    2: {targetAxisIndex: 1},
                },
                colors: ["orange", "blue", "red"]
            };


            var chart = new google.visualization.LineChart(document.getElementById('myChart'));
            chart.draw(data, options);
        }
    }
</script>

<div id="flyMap" style="width: 800px; height: 440px; border: 1px solid #AAA;"></div>

<script type="application/javascript">
    var map = L.map('flyMap', {
        center: [20.0, 5.0],
        minZoom: 2,
        zoom: 2
    });
    var polyline;



    function generateMap(serialNumber, flyDate) {
        if (polyline!=null) {
            map.removeLayer(polyline);
        }
        mapLink = '<a href="http://openstreetmap.org">OpenStreetMap</a>';
        L.tileLayer('http://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; ' + mapLink + ' Contributors',
            maxZoom: 22,
        }).addTo(map);

        json = $.ajax({
            dataType: "json",
            url: './displayFly?serialNumber='+ serialNumber +'&flyDate=' +flyDate.replace('+','%2B'),
            async: false
        }).responseJSON;



        var latlngs = [];
        for (var i = 0; i < json.length; ++i) {
            var p = L.latLng(json[i].lat,json[i].lng);
            latlngs[i] = p;
        }
        console.log(latlngs)
        polyline = L.polyline(latlngs,{color:'red',lineJoin: 'round'}).addTo(map);
        map.fitBounds(polyline.getBounds());
    }
</script>
<!--<style>-->
<!--html, body {-->
<!--height: 100%;-->
<!--margin: 0;-->
<!--padding: 0;-->
<!--}-->
<!--#myMap {-->
<!--height: 100%;-->
<!--}-->
<!--</style>-->
<!--<div id="myMap"></div>-->
<!--<script type="application/javascript">-->
<!--function initMap() {-->
<!--var map = new google.maps.Map(document.getElementById('myMap'), {-->
<!--zoom: 14,-->
<!--center: {lat: 48.8, lng: 2.24}-->
<!--});-->

<!--var georssLayer = new google.maps.KmlLayer({-->
<!--url: 'doc.kml',-->
<!--map: map-->
<!--});-->
<!--}-->
<!--</script>-->
<!--<script async defer-->
<!--src="https://maps.googleapis.com/maps/api/js?key=AIzaSyB0nPjEYBM-d5Sa20ebfr46FdXrlCjMNPI&signed_in=true&callback=initMap"></script>-->
</body>

</html>